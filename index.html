<!DOCTYPE html>
 <html>
 <head>
 <meta http-equiv="Content-Type" content="text/html; charset=windows-1251" />
 <title>Заметки</title>
 <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
  <script type="text/javascript" src="logic.js"></script>
 <script type="text/javascript">
   function init()
  {
        logicInit();
		updateData();
   }
   
   function onClearClick()
   {
	window.localStorage.clear();
	location.reload();
	return false;
   }
   
   function onAddClick()
  {
   var Description = $('#description').val();
   //если текстовое поле не заполнено
   if($("#description").val() == '') 
   {
    $('#alert').html("<strong>Внимание!</strong> Введите запись в текстовое поле.");
    $('#alert').fadeIn().delay(3000).fadeOut();
    return false;
   }

   allNotes.push(new Note(Description,parseTags(Description)));
   saveData();
   $('#form')[0].reset();
   //updateNotes();
   return false;
}

function updateData()
{
	var notes = document.getElementById("notes");
	var tags =  document.getElementById("tags");
	notes.innerHTML="";
	tags.innerHTML="";
	reloadData();
	console.log(notes.innerHTML)
	for (var i=0; i<allNotes.length;i++)
		notes.innerHTML="<textarea id='txtNote"+i+"' readonly>"+ allNotes[i].content + "</textarea>?<iframe id='frame"+i+"' style='display:none;'></iframe><div id='noteEditDel"+i+"'><button onClick='onEditNoteClick("+i+");'>Править</button><button onClick='onDeleteNoteClick("+i+");'>X</button></div>"
		+"<div id='noteOkCancel"+i+"' style='display:none;'><button onClick='onSaveNoteClick("+i+");'>Сохранить</button><button id='btnCancel"+i+"' onClick='onCancelNoteClick("+i+");'>Отмена</button><br></div> tags:"+allNotes[i].tags+"<br><br>"+notes.innerHTML;
	for (var i=0; i<allTags.length;i++)
		tags.innerHTML="<p id='pTag"+i+"' onclick=filterByTag("+i+")>"+allTags[i]+" <button onClick='onDeleteTagClick("+i+");'>X</button></p><br>"+tags.innerHTML;		
}

function onEditNoteClick(index)
{
    var noteTextArea = document.getElementById("txtNote"+index);
	noteTextArea.readOnly = false;
	
	var container = document.createElement("DIV");
	noteTextArea.parentNode.insertBefore(container, noteTextArea); 
    container.appendChild(noteTextArea);
    noteTextArea.style.display = 'none';

   var iFrame =  document.getElementById('frame'+index);
   iFrame.contentWindow.document.designMode = "On";
   iFrame.style.display = "block";
   var iFrameBody;
   if ( iFrame.contentDocument ) 
   { // FF
     iFrameBody = iFrame.contentDocument.getElementsByTagName('body')[0];
   }
   else if ( iFrame.contentWindow ) 
   { // IE
     iFrameBody = iFrame.contentWindow.document.getElementsByTagName('body')[0];
   }
    
	var text = noteTextArea.value;
	
	for (var i=0;i<allNotes[index].tags.length;i++)
	{
	console.log(text)
	    text = text.replace(new RegExp(allNotes[index].tags[i], 'i'),"<b>"+allNotes[index].tags[i]+"</b>")	
		
	}
	console.log(text)	
	iFrameBody.innerHTML = text;	

    document.getElementById("noteEditDel"+index).style.display = "none";
    document.getElementById("noteOkCancel"+index).style.display = "block";
}

function onCancelNoteClick(index)
{
    document.getElementById("txtNote"+index).readOnly = true;
	document.getElementById("txtNote"+index).style.display = "block";
	document.getElementById('frame'+index).style.display = "none";
	
	//document.getElementById("txtNote"+index).value=allNotes[index].content;
	document.getElementById("noteEditDel"+index).style.display = "block";
    document.getElementById("noteOkCancel"+index).style.display = "none";
}

function onSaveNoteClick(index)
{
    document.getElementById("txtNote"+index).readOnly = true;
	document.getElementById("txtNote"+index).style.display = "block";
	document.getElementById('frame'+index).style.display = "none";
	

	allNotes[index].content=document.getElementById('frame'+index).contentDocument.getElementsByTagName('body')[0].innerHTML;
	allNotes[index].tags=parseTags(allNotes[index].content);
	document.getElementById("noteEditDel"+index).style.display = "block";
    document.getElementById("noteOkCancel"+index).style.display = "none";
	saveData();
	updateData();
}

function onDeleteNoteClick(index)
{
	allNotes.splice(index,1);
	saveData();
	updateData();
}
function filterByTag(index)
{
   $('#notes').html('');
   var tag = allTags[index];
   	for (var i=0; i<allNotes.length;i++)
		if(allNotes[i].tags.indexOf(tag)!=-1)
			$('#notes').prepend("<textarea readonly>"+ allNotes[i].content + "</textarea readonly><br>"+"tags:"+allNotes[i].tags+"<br>");
}

function onDeleteTagClick(index)
{
    if((index>=0)&&(index<allTags.length))
	{
		allTags.splice(index,1);
		document.getElementById("pTag"+index).onclick=function(){};
		saveData();
	}
	updateData();
	//location.reload();
}

function onAddTagClick()
{
   var newTag = $('#newTag').val();
   if($("#newTag").val() == '') 
   {
    $('#alert').html("<strong>Внимание!</strong> Введите запись в текстовое поле.");
    $('#alert').fadeIn().delay(3000).fadeOut();
    return false;
   }
   allTags.push(newTag);
   saveData();
   $('#form')[0].reset();
   return false;
}

function onShowAllTagsClick()
{
   updateData();
}

 </script>
 </head>
 
 <body onLoad="init();">
   <table border="1">
   <tr>
	   <td>
		   Добавить новый тег: <br>
		    <form id="formTags" action="#" method="POST">
			  <input id="newTag" name="newTag" type="text"/>
			  <input id="addTag" type="submit" value="ОК" onClick="onAddTagClick();"/>
		    </form> <br>
			<button id="showAllTags" onClick="onShowAllTagsClick();">Все</button>
		    <ul id="tags"></ul>
	   </td>
		<td><section>
		  <form id="form" action="#" method="POST">
			  <textarea id="description" name="description"></textarea>
			  <input id="add" type="submit" value="Добавить запись" onClick="onAddClick();"/>
			  <button id="clear" onClick="onClearClick();">Очистить список</button>
		  </form>
		  <div id="alert"></div>
		  <ul id="notes"></ul>
		</section></td>
	</tr>	
	</table>
 </body>
 
 </html>